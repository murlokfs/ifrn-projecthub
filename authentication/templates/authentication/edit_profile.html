{% load static %}
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
    {% if user.is_authenticated %}
        Editar perfil de {{ user.full_name }} - PRISMA
    {% else %}
        Editar Perfil - PRISMA
    {% endif %}
    </title>
    <link rel="icon" href="{% static 'img/NewFavicon.ico' %}" type="image/x-icon">
    <link rel="shortcut icon" href="{% static 'img/NewFavicon.ico' %}" type="image/x-icon">

    <link rel="stylesheet" href="{% static 'base_files/footer.css' %}?v=20251113_2">
    <link rel="stylesheet" href="{% static 'css/edit_profile.css' %}">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .autocomplete-results.active {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: #f0f0f0;
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        #campus-input {
            padding-right: 35px !important;
        }

        .hidden-campus-id {
            display: none;
        }
    </style>
</head>

<body>
    <div class="main-wrapper">

        <a href="{% url 'profile' request.user.pk %}" class="back-link">
            <i class="ph ph-arrow-left"></i> Voltar ao perfil
        </a>

        <form action="" method="POST" class="profile-form">
            {% csrf_token %}

            <div class="page-header">

                <div class="avatar-wrapper" style="cursor: default;">
                    {% if user.image %}
                        <img src="{{ user.image }}" class="avatar-circle" style="object-fit: cover; border: none;">
                    {% else %}
                        <div class="avatar-circle">
                            {{ user.first_name|slice:":2"|upper }}
                        </div>
                    {% endif %}
                    
                    </div>

                <div class="header-texts">
                    <div class="title-row">
                        <i class="ph ph-pencil-simple header-icon"></i>
                        <h1>Editar Perfil</h1>
                    </div>
                    <p>Atualize suas redes sociais e descrição. Dados acadêmicos são sincronizados automaticamente.</p>
                </div>
            </div>

            <div class="form-card">

                <div class="card-title">
                    <i class="ph ph-user"></i>
                    <h2>Informações pessoais</h2>
                </div>
                <p class="card-subtitle">Alguns campos são gerenciados pela instituição e não podem ser alterados.</p>

                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" name="full_name" class="form-input" 
                               value="{{ user.full_name }}" 
                               readonly 
                               style="opacity: 0.7; cursor: not-allowed; background-color: #E5E7EB;">
                        <span class="helper-text">Sincronizado com o sistema acadêmico.</span>
                    </div>

                    <div class="form-group">
                        <label>Handle (nome de usuário)</label>
                        <input type="text" name="username" class="form-input" 
                               value="{{ user.username }}" readonly 
                               style="opacity: 0.7; cursor: not-allowed; background-color: #E5E7EB;">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Campus</label>
                        <div class="input-icon-wrapper autocomplete-container">
                            <i class="ph ph-buildings"></i>
                            <input type="text" id="campus-input" class="form-input has-icon" 
                                   placeholder="Digite o campus..." autocomplete="off"
                                   value="{% if user.campus %}{{ user.campus.name }}{% endif %}">
                            <input type="hidden" id="campus-id" name="campus" value="{% if user.campus %}{{ user.campus.id }}{% endif %}">
                            <div class="autocomplete-results" id="autocomplete-results"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>GitHub</label>
                        <div class="input-icon-wrapper">
                            <i class="ph ph-github-logo"></i>
                            <input type="url" name="github" class="form-input has-icon"
                                   value="{{ user.github|default:'' }}" placeholder="Link do GitHub">
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-bottom: 25px;">
                    <label>LinkedIn</label>
                    <div class="input-icon-wrapper">
                        <i class="ph ph-linkedin-logo"></i>
                        <input type="url" name="linkedin" class="form-input has-icon" 
                               value="{{ user.linkedin|default:'' }}" placeholder="Link do LinkedIn">
                    </div>
                </div>

                <div class="form-group full-width">
                    <label>Descrição (Sobre mim)</label>
                    <textarea name="about_me" class="form-textarea" 
                              placeholder="Conte um pouco sobre você...">{{ user.about_me|default:'' }}</textarea>
                </div>

                <div class="form-actions">
                    <a href="{% url 'profile' request.user.pk %}" class="btn-cancel">Cancelar</a>
                    <button type="submit" class="btn-confirm">Confirmar alterações</button>
                </div>

            </div>
        </form>

    </div>

    {% include 'components/base_files/footer.html' %}
    
    <script>
        const campusInput = document.getElementById('campus-input');
        const campusIdInput = document.getElementById('campus-id');
        const autocompleteResults = document.getElementById('autocomplete-results');
        let campusData = [];
        let selectedIndex = -1;

        // Função para fazer fetch dos resultados de autocomplete
        async function fetchCampusResults(query) {
            try {
                const response = await fetch(`/authentication/api/campus-autocomplete/?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                return data.results;
            } catch (error) {
                console.error('Erro ao buscar campus:', error);
                return [];
            }
        }

        // Função para renderizar os resultados
        function renderResults(results) {
            autocompleteResults.innerHTML = '';
            campusData = results;
            selectedIndex = -1;

            if (results.length === 0) {
                autocompleteResults.classList.remove('active');
                return;
            }

            results.forEach((result, index) => {
                const div = document.createElement('div');
                div.className = 'autocomplete-item';
                div.textContent = result.display;
                div.dataset.index = index;
                div.dataset.id = result.id;
                div.dataset.name = result.name;

                div.addEventListener('click', () => selectCampus(result));
                div.addEventListener('mouseenter', () => {
                    document.querySelectorAll('.autocomplete-item').forEach(item => 
                        item.classList.remove('selected')
                    );
                    div.classList.add('selected');
                    selectedIndex = index;
                });

                autocompleteResults.appendChild(div);
            });

            autocompleteResults.classList.add('active');
        }

        // Função para selecionar um campus
        function selectCampus(campus) {
            campusInput.value = campus.display;
            campusIdInput.value = campus.id;
            autocompleteResults.classList.remove('active');
            selectedIndex = -1;
        }

        // Event listener para o input
        campusInput.addEventListener('input', async (e) => {
            const query = e.target.value.trim();

            if (query.length === 0) {
                autocompleteResults.classList.remove('active');
                campusIdInput.value = '';
                return;
            }

            const results = await fetchCampusResults(query);
            renderResults(results);
        });

        // Event listener para o teclado
        campusInput.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % campusData.length;
                updateSelection();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = (selectedIndex - 1 + campusData.length) % campusData.length;
                updateSelection();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && campusData[selectedIndex]) {
                    selectCampus(campusData[selectedIndex]);
                }
            } else if (e.key === 'Escape') {
                autocompleteResults.classList.remove('active');
                selectedIndex = -1;
            }
        });

        function updateSelection() {
            document.querySelectorAll('.autocomplete-item').forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Fechar autocomplete ao clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                autocompleteResults.classList.remove('active');
            }
        });

        // Validação ao enviar o formulário
        document.querySelector('.profile-form').addEventListener('submit', (e) => {
            if (campusInput.value.trim() && !campusIdInput.value) {
                e.preventDefault();
                alert('Por favor, selecione um campus válido na lista de sugestões.');
            }
        });
    </script>
    
    </body>
</html>