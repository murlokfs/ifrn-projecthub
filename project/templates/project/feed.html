{% extends 'components/base_files/my_projects_and_feed.html' %}
{% load static %}

{% block title %}Feed - Project Hub{% endblock title %}

{% block imports %}
    <link rel="stylesheet" href="{% static 'css/new_feed.css' %}?v=header_fix">
{% endblock imports %}

{% block content %}
<div class="feed-wrapper">

    <main class="feed-main-column">

        <div class="feed-header-section">
            
            <div class="tabs-row">
                <a href="?tab=trending{% if search_query %}&q={{ search_query }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.tag %}&tag={{ filters.tag }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}" 
                   class="tab-btn {% if current_tab == 'trending' or not current_tab %}active{% endif %}">
                   Em alta
                </a>

                {% if user.is_authenticated %}
                <a href="?tab=my_campus{% if search_query %}&q={{ search_query }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.tag %}&tag={{ filters.tag }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}" 
                   class="tab-btn {% if current_tab == 'my_campus' %}active{% endif %}">
                   Meu Campus
                </a>
                {% endif %}
            </div>

            <div class="filters-row">
                <button class="btn-filter" onclick="toggleFilterPanel()">
                    <i class="ph ph-funnel"></i>Filtros
                </button>

                <div class="dropdown-sort">
                    <button class="dropdown-filter" onclick="toggleSortDropdown(event)">
                        <span id="sort-label">
                            {% if sort_by == 'oldest' %}
                                Mais antigos
                            {% else %}
                                Mais recentes
                            {% endif %}
                        </span>
                        <i class="ph ph-caret-down"></i>
                    </button>
                    
                    <div class="dropdown-menu" id="sortMenu" style="display: none;">
                        <a class="dropdown-item {% if sort_by == 'newest' or not sort_by %}active{% endif %}" 
                           href="?tab={{ current_tab|default:'trending' }}&sort=newest{% if search_query %}&q={{ search_query }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.tag %}&tag={{ filters.tag }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}">
                            <i class="ph ph-arrow-up"></i> Mais recentes
                        </a>
                        <a class="dropdown-item {% if sort_by == 'oldest' %}active{% endif %}" 
                           href="?tab={{ current_tab|default:'trending' }}&sort=oldest{% if search_query %}&q={{ search_query }}{% endif %}{% if filters.type %}&type={{ filters.type }}{% endif %}{% if filters.tag %}&tag={{ filters.tag }}{% endif %}{% if filters.status %}&status={{ filters.status }}{% endif %}">
                            <i class="ph ph-arrow-down"></i> Mais antigos
                        </a>
                    </div>
                </div>
            </div>

            <div id="filterPanel" class="filter-expanded-panel" 
                 {% if filters.type or filters.tag or filters.status %} style="display:block" {% else %} style="display:none" {% endif %}>
                
                <form method="get">
                    {# Mantém a busca #}
                    {% if search_query %}
                        <input type="hidden" name="q" value="{{ search_query }}">
                    {% endif %}
                    
                    {# Mantém a aba atual ao filtrar #}
                    <input type="hidden" name="tab" value="{{ current_tab|default:'trending' }}">

                    <div class="filter-grid">

                        <div class="filter-input-group">
                            <label>Tipo de Projeto</label>
                            <div class="select-wrapper">
                                <select name="type" class="custom-select">
                                    <option value="all">Todos os tipos</option>
                                    <option value="research" {% if filters.type == "research" %}selected{% endif %}>
                                        Pesquisa e Desenvolvimento
                                    </option>
                                    <option value="integrator" {% if filters.type == "integrator" %}selected{% endif %}>
                                        Projeto Integrador
                                    </option>
                                    <option value="thesis" {% if filters.type == "thesis" %}selected{% endif %}>
                                        TCC
                                    </option>
                                </select>
                                <i class="ph ph-caret-down select-icon"></i>
                            </div>
                        </div>

                        <div class="filter-input-group">
                            <label>Tag</label>
                            <div class="select-wrapper">
                                <select name="tag" class="custom-select">
                                    <option value="all">Todas as tags</option>
                                    {% for tag in tags %}
                                        <option value="{{ tag.id }}" {% if filters.tag == tag.id|stringformat:"s" %}selected{% endif %}>
                                            {{ tag.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <i class="ph ph-caret-down select-icon"></i>
                            </div>
                        </div>

                        <div class="filter-input-group">
                            <label>Status</label>
                            <div class="select-wrapper">
                                <select name="status" class="custom-select">
                                    <option value="all">Todos</option>
                                    <option value="pending_approval" {% if filters.status == "pending_approval" %}selected{% endif %}>
                                        Pendente
                                    </option>
                                    <option value="in_progress" {% if filters.status == "in_progress" %}selected{% endif %}>
                                        Em andamento
                                    </option>
                                    <option value="completed" {% if filters.status == "completed" %}selected{% endif %}>
                                        Concluído
                                    </option>
                                </select>
                                <i class="ph ph-caret-down select-icon"></i>
                            </div>
                        </div>

                        <div class="filter-input-group filter-actions">
                            <button type="submit" class="btn-apply-filters">
                                Aplicar filtros
                            </button>
                        </div>

                    </div>
                </form>
            </div>

            <script>
                function toggleFilterPanel() {
                    const panel = document.getElementById('filterPanel');
                    const btn = document.querySelector('.btn-filter');

                    if (panel.style.display === 'none' || panel.style.display === '') {
                        panel.style.display = 'block';
                        btn.style.borderColor = 'var(--primary)';
                        btn.style.color = 'var(--primary)';
                    } else {
                        panel.style.display = 'none';
                        btn.style.borderColor = '';
                        btn.style.color = '';
                    }
                }

                function toggleSortDropdown(event) {
                    event.preventDefault();
                    const sortMenu = document.getElementById('sortMenu');
                    const isVisible = sortMenu.style.display === 'block';
                    sortMenu.style.display = isVisible ? 'none' : 'block';
                }

                // Fechar dropdown ao clicar fora
                document.addEventListener('click', function(event) {
                    const dropdown = document.querySelector('.dropdown-sort');
                    if (dropdown && !dropdown.contains(event.target)) {
                        document.getElementById('sortMenu').style.display = 'none';
                    }
                });
            </script>
        </div>

        {% if search_query %}
            <p class="search-info">
                Resultados para: <strong>"{{ search_query }}"</strong>
            </p>
        {% endif %}

        <div class="feed-list">
            {% for projeto in projects %}
                <article class="feed-card">

                    <div class="card-image-box">
                        {% if projeto.image %}
                            <img src="{{ projeto.image.url }}" alt="Capa do projeto {{ projeto.title }}">
                        {% else %}
                            <img src="https://images.unsplash.com/photo-1555066931-4365d14bab8c?q=80&w=1000&auto=format&fit=crop">
                        {% endif %}
                        
                        <div class="card-badges-container">
                            <span class="floating-tag">{{ projeto.get_type_display }}</span>
                            <span class="status-badge 
                                {% if projeto.status == 'pending_approval' %}
                                    outline-yellow
                                {% elif projeto.status == 'in_progress' %}
                                    outline-blue
                                {% elif projeto.status == 'completed' %}
                                    outline-green
                                {% endif %}
                                ">
                                {{ projeto.get_status_display }}
                            </span>
                        </div>
                    </div>

                    <div class="card-content">
                        <div class="author-row">
                            <div class="avatar-mini">
                                {{ projeto.members.first.full_name|default:"?"|slice:":2"|upper }}
                            </div>
                            <div class="author-info">
                                <strong>{{ projeto.members.first.full_name|default:"Autor não informado" }}</strong>
                                <span>
                                    <i class="ph ph-calendar-blank"></i> {{ projeto.created_at|date:"d/m/Y" }}
                                </span>
                            </div>
                        </div>

                        <h2 class="project-title">{{ projeto.title }}</h2>
                        <p class="project-desc">
                            {{ projeto.description|striptags|safe|truncatechars:120 }}
                        </p>

                        <div class="tags-row">
                            {% for tag in projeto.tags.all %}
                                <span class="tech-tag">{{ tag.name }}</span>
                            {% empty %}
                                <span class="tech-tag muted">Sem tags</span>
                            {% endfor %}
                        </div>

                        <div class="members-info">
                            <i class="ph ph-users"></i> {{ projeto.members.count }} membro(s)
                        </div>

                        <div class="card-footer">
                            <div class="stats-icons">
                                {% include 'components/cards/project_parts/interaction_btns.html' %}
                            </div>
                            <a href="{% url 'project_details' pk=projeto.id %}" class="btn-details">
                                Ver Detalhes <i class="ph ph-arrow-up-right"></i>
                            </a>
                        </div>
                    </div>
                </article>
            {% empty %}
                <p>Nenhum projeto encontrado.</p>
            {% endfor %}
        </div>

        {% if is_paginated %}
            <div class="pagination-container">

            {% if page_obj.has_previous %}
                <a class="pagination-arrow"
                   href="?page={{ page_obj.previous_page_number }}&tab={{ current_tab|default:'trending' }}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                    ‹
                </a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                    <span class="pagination-number active">
                        {{ num }}
                    </span>
                {% else %}
                    <a class="pagination-number"
                       href="?page={{ num }}&tab={{ current_tab|default:'trending' }}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                        {{ num }}
                    </a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a class="pagination-arrow"
                   href="?page={{ page_obj.next_page_number }}&tab={{ current_tab|default:'trending' }}{% if request.GET.type %}&type={{ request.GET.type }}{% endif %}{% if request.GET.tag %}&tag={{ request.GET.tag }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if search_query %}&q={{ search_query }}{% endif %}">
                    ›
                </a>
            {% endif %}

            </div>
        {% endif %}

    </main>

    <aside class="feed-sidebar">

        <div class="sidebar-widget widget-create">
            <div class="widget-create-header">
                <i class="ph ph-plus-circle"></i>
                <h3>Criar Projeto</h3>
            </div>
            <p>Compartilhe seu trabalho acadêmico e receba feedback da comunidade.</p>
            <a href="{% url 'create_project' %}" class="btn-white-full">Começar Agora</a>
        </div>

        <div class="sidebar-widget">
            <div class="widget-title">
                <i class="ph ph-trend-up"></i> Tags em Alta
            </div>
            <div class="cloud-tags">
                {% for tag in tags %}
                    <a href="?tag={{ tag.id }}&tab={{ current_tab|default:'trending' }}" class="cloud-tag" style="text-decoration: none; color: inherit;"># {{ tag.name }}</a>
                {% endfor %}
            </div>
        </div>

    </aside>

</div>
{% endblock content %}