<div id="evaluationModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <form id="evaluationForm" method="post" action="">
                {% csrf_token %}
                <div class="modal-header">
                    <div class="header-texts">
                        <h2>Avaliar Projeto</h2>
                        <p>Revise o projeto e forneça seu feedback ao aluno</p>
                    </div>
                    <button type="button" class="btn-close" onclick="closeModal()">
                        <i class="ph ph-x"></i>
                    </button>
                </div>

                <div class="modal-body">

                    <div class="project-summary-box">
                        <h3 id="modalProjectTitle">Título do Projeto</h3>
                        <div class="subtitle-row">
                            <i class="ph-fill ph-graduation-cap"></i>
                            <span id="modalProjectType">Tipo do Projeto</span>
                        </div>
                        <div class="tags-row mini-tags" id="modalProjectTags">
                            <!-- Tags serão preenchidas dinamicamente -->
                        </div>
                    </div>

                    <div class="form-section">
                        <label class="section-label">
                            <i class="ph ph-warning-circle"></i> Decisão *
                        </label>

                        <div class="decision-options">
                            <input type="radio" name="decision" id="opt-approve" value="approve" class="hidden-radio" required>
                            <label for="opt-approve" class="option-card option-approve">
                                <div class="radio-circle">
                                    <div class="radio-dot"></div>
                                </div>
                                <div class="option-icon-box success"><i class="ph ph-check"></i></div>
                                <div class="option-texts">
                                    <strong>Aprovar Projeto</strong>
                                    <span>O projeto será publicado na plataforma</span>
                                </div>
                            </label>

                            <input type="radio" name="decision" id="opt-reject" value="reject" class="hidden-radio" required>
                            <label for="opt-reject" class="option-card option-reject">
                                <div class="radio-circle">
                                    <div class="radio-dot"></div>
                                </div>
                                <div class="option-icon-box danger"><i class="ph ph-x"></i></div>
                                <div class="option-texts">
                                    <strong>Reprovar Projeto</strong>
                                    <span>O projeto não será publicado</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <label class="section-label">
                            <i class="ph ph-warning-circle"></i> Feedback para o aluno *
                        </label>
                        <textarea name="feedback" class="feedback-input" required
                            placeholder="Explique os pontos positivos e melhorias..."></textarea>
                        <p class="helper-text">O aluno poderá visualizar este feedback</p>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Confirmar avaliação</button>
                </div>
            </form>
        </div>
    </div>

<script>
    // --- FUNÇÕES GLOBAIS (Acessíveis pelo HTML) ---

    // ==========================
    // 1. MODAL DE AVALIAÇÃO
    // ==========================
    function openModal(projectId, projectTitle, projectType, projectTags) {
        const input = document.querySelector('.feedback-input');
        if (input) input.classList.remove('input-error');

        // Limpa a seleção dos radios
        const radios = document.querySelectorAll('input[name="decision"]');
        radios.forEach(r => r.checked = false);

        // Limpa o texto
        if (input) input.value = '';

        // Preenche informações do projeto no modal
        const titleElement = document.getElementById('modalProjectTitle');
        const typeElement = document.getElementById('modalProjectType');
        const tagsElement = document.getElementById('modalProjectTags');
        const form = document.getElementById('evaluationForm');

        if (titleElement) titleElement.textContent = projectTitle || 'Título do Projeto';
        if (typeElement) typeElement.textContent = projectType || 'Tipo do Projeto';
        
        // Preenche tags
        if (tagsElement) {
            tagsElement.innerHTML = '';
            if (projectTags && projectTags.length > 0) {
                projectTags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag';
                    tagSpan.textContent = tag;
                    tagsElement.appendChild(tagSpan);
                });
            } else {
                const tagSpan = document.createElement('span');
                tagSpan.className = 'tag no-tags';
                tagSpan.textContent = 'Sem tags';
                tagsElement.appendChild(tagSpan);
            }
        }

        // Define o action do formulário
        if (form && projectId) {
            form.action = `/projects/evaluate/${projectId}/`;
        }

        const modal = document.getElementById('evaluationModal');
        if(modal) modal.style.display = 'flex';
    }

    function closeModal() {
        const modal = document.getElementById('evaluationModal');
        if(modal) modal.style.display = 'none';
    }


    // ==========================
    // 2. MODAL DE EXCLUSÃO (Lógica do Django integrada)
    // ==========================
    
    // Variável global para guardar o ID do projeto que será deletado
    let projectToDeleteId = null; 

    // Agora recebe projectId E projectName
    function openDeleteModal(projectId, projectName) {
        // Compatibilidade: se apenas um argumento (nome) for passado
        if (projectName === undefined && typeof projectId === 'string') {
            projectName = projectId;
            projectId = null;
        }

        // 1. Guarda o ID (se houver)
        projectToDeleteId = projectId;

        // 2. Atualiza o texto em negrito com o nome do projeto clicado
        const nameElement = document.getElementById('deleteProjectName');
        if (nameElement) {
            nameElement.innerText = `"${projectName || 'Nome do Projeto'}"`;
        }
        
        // 3. Exibe o modal
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeDeleteModal() {
        const modal = document.getElementById('deleteModal');
        if (modal) {
            modal.style.display = 'none';
        }
        projectToDeleteId = null; // Limpa a variável por segurança
    }

    function confirmDelete() {
        if (projectToDeleteId) {
            // REDIRECIONA PARA A URL DE DELETAR DO DJANGO
            window.location.href = `/projetos/deletar/${projectToDeleteId}/`;
        } else {
            console.error("Erro: Nenhum ID de projeto encontrado para exclusão.");
            closeDeleteModal();
        }
    }

    // ==========================
    // 2.5 MODAL DE DEATIVAÇÃO (Soft Delete via AJAX)
    // ==========================
    let projectToDeactivateId = null;

    function openDeactivateModal(projectId, projectName) {
        projectToDeactivateId = projectId;
        
        const nameElement = document.getElementById('deactivateProjectName');
        if (nameElement) {
            nameElement.innerText = `"${projectName || 'Nome do Projeto'}"`;
        }
        
        const modal = document.getElementById('deactivateModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeDeactivateModal() {
        const modal = document.getElementById('deactivateModal');
        if (modal) {
            modal.style.display = 'none';
        }
        projectToDeactivateId = null;
    }

    function confirmDeactivate() {
        if (!projectToDeactivateId) {
            console.error("Erro: Nenhum ID de projeto encontrado para deativação.");
            closeDeactivateModal();
            return;
        }

        // Envia requisição POST via AJAX
        fetch(`/projects/deactivate/${projectToDeactivateId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostra mensagem de sucesso
                alert(data.message || 'Projeto desativado com sucesso!');
                
                // Remove o card do DOM
                const card = document.querySelector(`[data-project-id="${projectToDeactivateId}"]`);
                if (card) {
                    card.style.opacity = '0.5';
                    setTimeout(() => {
                        card.style.display = 'none';
                    }, 300);
                }
                
                // Fecha o modal
                closeDeactivateModal();
                
                // Recarrega a página após 1 segundo
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('Erro: ' + (data.message || 'Não foi possível desativar o projeto'));
            }
        })
        .catch(error => {
            console.error('Erro na requisição:', error);
            alert('Erro ao tentar desativar o projeto. Tente novamente.');
        });
    }

    // Função auxiliar para obter CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // ==========================
    // 3. MODAL DE CONCLUSÃO
    // ==========================
    let projectToCompleteId = null;

    function openCompleteModal(projectId, projectTitle) {
        projectToCompleteId = projectId;
        
        const titleElement = document.getElementById('completeProjectName');
        if (titleElement) {
            titleElement.textContent = projectTitle || 'Nome do Projeto';
        }
        
        const modal = document.getElementById('completeModal');
        if (modal) {
            modal.style.display = 'flex';
        }
    }

    function closeCompleteModal() {
        const modal = document.getElementById('completeModal');
        if (modal) {
            modal.style.display = 'none';
        }
        projectToCompleteId = null;
    }

    function confirmComplete() {
        if (projectToCompleteId) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/projects/complete/${projectToCompleteId}/`;
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'csrfmiddlewaretoken';
                input.value = csrfToken.value;
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            form.submit();
        } else {
            console.error("Erro: Nenhum ID de projeto encontrado para conclusão.");
            closeCompleteModal();
        }
    }


    // --- EVENTOS DE CARREGAMENTO & FECHAMENTO GERAL ---
    document.addEventListener("DOMContentLoaded", () => {
        
        // Remove borda vermelha ao digitar no feedback
        const feedbackInput = document.querySelector('.feedback-input');
        if (feedbackInput) {
            feedbackInput.addEventListener('input', function () {
                if (this.value.trim() !== "") {
                    this.classList.remove('input-error');
                }
            });
        }
    });

    // Fecha os modais se clicar fora deles (Overlay)
    window.onclick = function(event) {
        const modalDelete = document.getElementById('deleteModal');
        const modalDeactivate = document.getElementById('deactivateModal');
        const modalEval = document.getElementById('evaluationModal');
        const modalComplete = document.getElementById('completeModal');

        if (event.target == modalDelete) {
            closeDeleteModal();
        }
        if (event.target == modalDeactivate) {
            closeDeactivateModal();
        }
        if (event.target == modalEval) {
            closeModal();
        }
        if (event.target == modalComplete) {
            closeCompleteModal();
        }
    }
</script>

    <div id="deleteModal" class="modal-overlay" style="display: none;">
        <div class="modal-container delete-theme">
            <div class="modal-body delete-body">
                <div class="delete-header">
                    <i class="ph ph-warning"></i>
                    <h2>Excluir Projeto por Violação</h2>
                </div>

                <p class="delete-desc">
                    Você está prestes a excluir permanentemente o projeto <strong id="deleteProjectName">"Nome do
                        Projeto"</strong> por violar diretrizes éticas ou direitos humanos.
                </p>

                <p class="delete-warning">
                    Esta ação é irreversível e o aluno será notificado sobre a exclusão e o motivo.
                </p>
            </div>

            <div class="modal-footer delete-footer">
                <button class="btn-secondary" onclick="closeDeleteModal()">Cancelar</button>
                <button class="btn-danger" onclick="confirmDelete()">Confirmar Exclusão</button>
            </div>

        </div>
    </div>

    <!-- Modal de Deativação (Soft Delete) -->
    <div id="deactivateModal" class="modal-overlay" style="display: none;">
        <div class="modal-container delete-theme">
            <div class="modal-body delete-body">
                <div class="delete-header">
                    <i class="ph ph-archive"></i>
                    <h2>Desativar Projeto</h2>
                </div>

                <p class="delete-desc">
                    Você está prestes a desativar o projeto <strong id="deactivateProjectName">"Nome do Projeto"</strong>.
                </p>

                <p class="delete-warning" style="color: #666; background-color: #f0f4f8; padding: 12px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                    <i class="ph ph-info" style="margin-right: 8px;"></i>
                    O projeto será ocultado da plataforma, mas os dados serão preservados no banco de dados para qualquer eventualidade.
                </p>
            </div>

            <div class="modal-footer delete-footer">
                <button class="btn-secondary" onclick="closeDeactivateModal()">Cancelar</button>
                <button class="btn-primary" onclick="confirmDeactivate()" style="background-color: #f59e0b; border-color: #f59e0b;">
                    <i class="ph ph-check" style="margin-right: 6px;"></i>Confirmar Deativação
                </button>
            </div>
        </div>
    </div>


    <div id="completeModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <div class="header-texts">
                    <h2><i class="ph ph-check-circle" style="margin-right: 8px;"></i>Concluir Projeto</h2>
                    <p>Marque este projeto como concluído</p>
                </div>
                <button type="button" class="btn-close" onclick="closeCompleteModal()">
                    <i class="ph ph-x"></i>
                </button>
            </div>

            <div class="modal-body">
                <div class="complete-info">
                    <div class="info-icon" style="text-align: center; margin-bottom: 20px;">
                        <i class="ph ph-check-circle" style="font-size: 64px; color: #10b981;"></i>
                    </div>
                    
                    <p style="text-align: center; margin-bottom: 20px; font-size: 16px;">
                        Você está prestes a marcar o projeto <strong id="completeProjectName">Nome do Projeto</strong> como <strong>Concluído</strong>.
                    </p>

                    <p style="text-align: center; color: #666; font-size: 14px;">
                        Esta ação indicará que o projeto foi finalizado com sucesso e estará visível aos alunos como concluído.
                    </p>
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCompleteModal()">Cancelar</button>
                <button type="button" class="btn-primary" onclick="confirmComplete()" style="background-color: #10b981; border-color: #10b981;">
                    <i class="ph ph-check" style="margin-right: 8px;"></i>Confirmar Conclusão
                </button>
            </div>
        </div>
    </div>