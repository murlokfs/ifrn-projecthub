<div class="form-container">
    <h2 class="form-title">{% if object %}Editando Projeto{% else %}Cadastrando Projeto{% endif %}</h2>

    <form method="post" enctype="multipart/form-data" style="width: 100%;">
        {% csrf_token %}
        {{ form.media }} 
        
        <div class="form-group">
            <label>Nome do projeto <span class="required">*</span></label>
            <input type="text" name="title" class="custom-input" 
                   value="{{ form.title.value|default:'' }}" 
                   placeholder="Ex: Project Hub - Armazene seus projetos">
            <div class="helper-text">3-150 caracteres, Alfanuméricos, hífen e pontos permitidos</div>
        </div>

        <div class="form-group">
    <label>Imagem de Apresentação (Banner) <span class="required">*</span></label>
    {{ form.image }}
    <div id="banner-preview-container" style="display: none; margin-top: 15px;">
        <img id="banner-preview-img" src="" alt="Preview do Banner" 
             style="width: 100%; max-height: 250px; object-fit: cover; border-radius: 12px; border: 1px solid #e2e8f0;">
    </div>
</div>

        <div class="form-group" width="100%">
            <label>Descrição geral <span class="required">*</span></label>
            {{ form.description }}
        </div>

        <div class="form-row" style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px;">
            <div class="form-col" style="flex: 1;">
            <label>Visibilidade</label>
            <div class="toggle-wrapper">
                <label class="switch">
                    <input type="checkbox" name="is_private" id="id_is_private" {% if form.is_private.value %}checked{% endif %}>
                    <span class="slider round"></span>
                </label>
                <div class="toggle-text">
                    <strong id="visibilityStatusText">{% if form.is_private.value %}Privado{% else %}Público{% endif %}</strong>
                    <span id="visibilityHelperText">{% if form.is_private.value %}Apenas membros autorizados{% else %}Visível para todos os usuários{% endif %}</span>
                </div>
            </div>
        </div>

            <div class="form-col" style="flex: 1;">
                <label>Tipo de projeto</label>
                {{ form.type }}
            </div>
        </div>
        <div class="form-group">
            <label>Professores orientadores <span class="required">*</span></label>
            <button type="button" class="btn-trigger btn-teacher" onclick="openModal('professor')">
                <i class="ph ph-graduation-cap"></i> Selecionar Professores Orientadores
            </button>
            <div id="orientators-list" class="chips-container"></div>
            <select name="orientators" id="id_orientators" multiple hidden></select>
        </div>

        <div class="form-group">
            <label>Integrantes <span class="required">*</span></label>
            <button type="button" class="btn-trigger btn-student" onclick="openModal('member')">
                <i class="ph ph-users"></i> Convidar integrantes
            </button>
            <div id="membersList" class="chips-container"></div>
            <select name="members" id="id_members" multiple hidden></select>
            {% comment %} {% if object %}
            <div id="user-data" data-id="{{ request.user.id }}" data-name="{{ request.user.full_name }}"></div>
            {% endif %} {% endcomment %}
        </div>

        <div class="form-group">
            <label>Tags <span class="required">*</span></label>
            <button type="button" class="btn-trigger btn-tag-red" onclick="openModal('tag')">
                <i class="ph ph-tag"></i> Adicionar Tags
            </button>
            <div id="tagsList" class="chips-container"></div>
            <select name="tags" id="id_tags" multiple hidden></select>
        </div>

        <div class="form-group">
            <label>Link do repositório no GitHub</label>
            <div class="input-with-icon">
                <i class="ph ph-github-logo"></i>
                {{ form.link_github }}
            </div>
        </div>

        <div class="form-group">
            <label>Link do vídeo no YouTube</label>
            <div class="input-with-icon">
                <i class="ph ph-youtube-logo"></i>
                {{ form.link_youtube }}
            </div>
            <div id="video-preview-container" style="display: none; margin-top: 15px;"></div>
        </div>

        <button type="submit" class="btn-submit" style="display: none; margin-top: 30px;">Salvar Projeto</button>
    </form>
</div>

<div id="searchModal" class="modal-overlay" style="display:none;">
    <div class="modal-container">
        <div class="modal-header">
            <h3 id="modalTitle">Convidar Integrantes</h3>
            <button class="close-icon" onclick="closeModal()">&times;</button>
        </div>

        <div class="modal-search-wrapper">
            <i class="ph ph-magnifying-glass"></i>
            <input type="text" id="modalSearchInput" placeholder="Buscar por nome, instituição ou campus..." oninput="debounceSearch()">
        </div>

        <div class="selection-counter" id="selectionCounter">0 selecionado(s)</div>

        <div id="modalResults" class="modal-results-scroll">
            </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeModal()">Cancelar</button>
            <button type="button" class="btn-confirm-final" onclick="confirmSelection()">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Publicação -->
<div id="confirmationModal" class="modal-overlay confirmation-modal" style="display: none;">
    <div class="modal-container confirmation-container">
        <div class="modal-header">
            <h3>Confirmar Publicação</h3>
            <button class="close-icon" onclick="closeConfirmationModal()">&times;</button>
        </div>

        <div class="confirmation-content">
            <div class="confirmation-icon">
                <i class="ph ph-check-circle"></i>
            </div>
            <p class="confirmation-message">Você tem certeza que deseja publicar este projeto?</p>
            <p class="confirmation-subtitle">Uma vez publicado, o projeto será enviado para aprovação dos professores orientadores.</p>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeConfirmationModal()">Cancelar</button>
            <button type="button" class="btn-confirm-final" onclick="submitProjectForm()">Publicar Projeto</button>
        </div>
    </div>
</div>

{% if object %}
<script>
    // Script para pré-preencher os dados quando estiver editando
    document.addEventListener("DOMContentLoaded", () => {
        // Função auxiliar para remover chips (compatibilidade)
        window.removeChip = function(element, id, type) {
            const selectId = type === 'tags' ? 'id_tags' : (type === 'orientators' ? 'id_orientators' : 'id_members');
            const hiddenSelect = document.getElementById(selectId);
            if (hiddenSelect) {
                for (let i = 0; i < hiddenSelect.options.length; i++) {
                    if (hiddenSelect.options[i].value == id) { 
                        hiddenSelect.remove(i); 
                        break; 
                    }
                }
            }
            if (element && element.closest('.chip-item')) {
                element.closest('.chip-item').remove();
            }
            // Atualizar o botão de publicar (aguarda a função estar disponível)
            setTimeout(() => {
                if (typeof window.updatePublishButton === 'function') {
                    window.updatePublishButton();
                }
            }, 0);
        };

        // Aguardar o carregamento completo do script principal
        setTimeout(() => {
            // Preencher orientadores
            {% if object.orientators.all %}
            const orientatorsList = document.getElementById('orientators-list');
            const orientatorsSelect = document.getElementById('id_orientators');
            {% for orientator in object.orientators.all %}
                const opt{{ forloop.counter }} = new Option('{{ orientator.full_name }}', '{{ orientator.id }}', true, true);
                orientatorsSelect.add(opt{{ forloop.counter }});
                
                const chip{{ forloop.counter }} = document.createElement('div');
                chip{{ forloop.counter }}.className = 'chip-item';
                chip{{ forloop.counter }}.dataset.id = '{{ orientator.id }}';
                chip{{ forloop.counter }}.innerHTML = `
                    {{ orientator.full_name }}
                    <button type="button" class="chip-remove" onclick="removeChip(this, '{{ orientator.id }}', 'orientators')">×</button>
                `;
                orientatorsList.appendChild(chip{{ forloop.counter }});
            {% endfor %}
            {% endif %}

            // Preencher membros
            {% if object.members.all %}
            const membersList = document.getElementById('membersList');
            const membersSelect = document.getElementById('id_members');
            {% for member in object.members.all %}
                const mem{{ forloop.counter }} = new Option('{{ member.full_name }}', '{{ member.id }}', true, true);
                membersSelect.add(mem{{ forloop.counter }});
                
                const chipMem{{ forloop.counter }} = document.createElement('div');
                chipMem{{ forloop.counter }}.className = 'chip-item';
                chipMem{{ forloop.counter }}.dataset.id = '{{ member.id }}';
                {% if member.id == request.user.id %}
                chipMem{{ forloop.counter }}.classList.add('owner-chip');
                chipMem{{ forloop.counter }}.innerHTML = `{{ member.full_name }} (Você)`;
                {% else %}
                chipMem{{ forloop.counter }}.innerHTML = `
                    {{ member.full_name }}
                    <button type="button" class="chip-remove" onclick="removeChip(this, '{{ member.id }}', 'members')">×</button>
                `;
                {% endif %}
                membersList.appendChild(chipMem{{ forloop.counter }});
            {% endfor %}
            {% endif %}

            // Preencher tags
            {% if object.tags.all %}
            const tagsList = document.getElementById('tagsList');
            const tagsSelect = document.getElementById('id_tags');
            {% for tag in object.tags.all %}
                const tag{{ forloop.counter }} = new Option('{{ tag.name }}', '{{ tag.id }}', true, true);
                tagsSelect.add(tag{{ forloop.counter }});
                
                const chipTag{{ forloop.counter }} = document.createElement('div');
                chipTag{{ forloop.counter }}.className = 'chip-item tag-chip';
                chipTag{{ forloop.counter }}.dataset.id = '{{ tag.id }}';
                chipTag{{ forloop.counter }}.innerHTML = `
                    {{ tag.name }}
                    <button type="button" class="chip-remove" onclick="removeChip(this, '{{ tag.id }}', 'tags')">×</button>
                `;
                tagsList.appendChild(chipTag{{ forloop.counter }});
            {% endfor %}
            {% endif %}

            // Preencher preview do banner se existir
            {% if object.image %}
            const bannerPreviewContainer = document.getElementById('banner-preview-container');
            const bannerPreviewImg = document.getElementById('banner-preview-img');
            if (bannerPreviewContainer && bannerPreviewImg) {
                bannerPreviewImg.src = '{{ object.image.url }}';
                bannerPreviewContainer.style.display = 'block';
            }
            {% endif %}

            // Atualizar o botão de publicar
            if (typeof window.updatePublishButton === 'function') {
                window.updatePublishButton();
            }
        }, 100); // Aguarda 100ms para garantir que o script principal foi carregado
    });
</script>
{% endif %}